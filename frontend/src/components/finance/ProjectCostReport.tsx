'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Progress } from '@/components/ui/progress';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Building, TrendingUp, TrendingDown, AlertTriangle, Download, Eye } from 'lucide-react';\nimport { toast } from '@/hooks/use-toast';\n\ninterface CostSummary {\n  material: number;\n  labour: number;\n  equipment: number;\n  subcontractor: number;\n  overhead: number;\n}\n\ninterface BudgetAnalysis {\n  totalBudget: number;\n  totalActualCost: number;\n  totalCommitted: number;\n  variance: number;\n  utilizationPercent: number;\n}\n\ninterface CostCenter {\n  _id: string;\n  name: string;\n  budget: number;\n  actualCost: number;\n  committedCost: number;\n}\n\ninterface Transaction {\n  _id: string;\n  date: string;\n  description: string;\n  debit: number;\n  credit: number;\n  accountId: {\n    code: string;\n    name: string;\n  };\n  journalEntryId: {\n    entryNumber: string;\n    reference: string;\n  };\n}\n\ninterface ProjectCostData {\n  projectId: string;\n  costSummary: CostSummary;\n  budgetAnalysis: BudgetAnalysis;\n  costCenters: CostCenter[];\n  recentTransactions: Transaction[];\n}\n\nconst ProjectCostReport = () => {\n  const [data, setData] = useState<ProjectCostData | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [selectedProject, setSelectedProject] = useState('');\n  const [dateRange, setDateRange] = useState({\n    fromDate: '',\n    toDate: ''\n  });\n  const [projects] = useState([\n    { id: 'project1', name: 'Highway Construction Project' },\n    { id: 'project2', name: 'Commercial Building Project' },\n    { id: 'project3', name: 'Residential Complex Project' }\n  ]);\n\n  useEffect(() => {\n    if (selectedProject) {\n      fetchProjectCostReport();\n    }\n  }, [selectedProject]);\n\n  const fetchProjectCostReport = async () => {\n    if (!selectedProject) return;\n    \n    try {\n      setLoading(true);\n      const queryParams = new URLSearchParams();\n      if (dateRange.fromDate) queryParams.append('fromDate', dateRange.fromDate);\n      if (dateRange.toDate) queryParams.append('toDate', dateRange.toDate);\n      \n      const response = await fetch(`/api/gl/reports/project-cost/${selectedProject}?${queryParams}`);\n      if (response.ok) {\n        const result = await response.json();\n        setData(result);\n      } else {\n        throw new Error('Failed to fetch project cost report');\n      }\n    } catch (error) {\n      toast({ title: 'Error', description: 'Failed to fetch project cost report', variant: 'destructive' });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-IN', {\n      style: 'currency',\n      currency: 'INR',\n      minimumFractionDigits: 2\n    }).format(amount);\n  };\n\n  const getVarianceColor = (variance: number) => {\n    if (variance > 0) return 'text-green-600';\n    if (variance < 0) return 'text-red-600';\n    return 'text-gray-600';\n  };\n\n  const getUtilizationColor = (percent: number) => {\n    if (percent <= 80) return 'bg-green-500';\n    if (percent <= 95) return 'bg-yellow-500';\n    return 'bg-red-500';\n  };\n\n  const getCostHeadIcon = (costHead: string) => {\n    const icons = {\n      material: 'üß±',\n      labour: 'üë∑',\n      equipment: 'üöú',\n      subcontractor: 'üèóÔ∏è',\n      overhead: 'üìä'\n    };\n    return icons[costHead as keyof typeof icons] || 'üìã';\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-3xl font-bold\">Project Cost Report</h1>\n        <Button variant=\"outline\">\n          <Download className=\"w-4 h-4 mr-2\" />\n          Export Report\n        </Button>\n      </div>\n\n      {/* Project Selection */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Select Project & Date Range</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">Project</label>\n              <Select value={selectedProject} onValueChange={setSelectedProject}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select Project\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {projects.map(project => (\n                    <SelectItem key={project.id} value={project.id}>\n                      {project.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">From Date</label>\n              <Input\n                type=\"date\"\n                value={dateRange.fromDate}\n                onChange={(e) => setDateRange(prev => ({ ...prev, fromDate: e.target.value }))}\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">To Date</label>\n              <Input\n                type=\"date\"\n                value={dateRange.toDate}\n                onChange={(e) => setDateRange(prev => ({ ...prev, toDate: e.target.value }))}\n              />\n            </div>\n            <div className=\"flex items-end\">\n              <Button onClick={fetchProjectCostReport} className=\"w-full\">\n                Generate Report\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {loading ? (\n        <div className=\"flex justify-center items-center h-32\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n        </div>\n      ) : data ? (\n        <Tabs defaultValue=\"overview\" className=\"space-y-6\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n            <TabsTrigger value=\"cost-breakdown\">Cost Breakdown</TabsTrigger>\n            <TabsTrigger value=\"cost-centers\">Cost Centers</TabsTrigger>\n            <TabsTrigger value=\"transactions\">Recent Transactions</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"overview\" className=\"space-y-6\">\n            {/* Budget Analysis Cards */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Total Budget</CardTitle>\n                  <Building className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{formatCurrency(data.budgetAnalysis.totalBudget)}</div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Actual Cost</CardTitle>\n                  <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{formatCurrency(data.budgetAnalysis.totalActualCost)}</div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Committed Cost</CardTitle>\n                  <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{formatCurrency(data.budgetAnalysis.totalCommitted)}</div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Variance</CardTitle>\n                  {data.budgetAnalysis.variance >= 0 ? \n                    <TrendingUp className=\"h-4 w-4 text-green-600\" /> : \n                    <TrendingDown className=\"h-4 w-4 text-red-600\" />\n                  }\n                </CardHeader>\n                <CardContent>\n                  <div className={`text-2xl font-bold ${getVarianceColor(data.budgetAnalysis.variance)}`}>\n                    {formatCurrency(Math.abs(data.budgetAnalysis.variance))}\n                    {data.budgetAnalysis.variance < 0 && ' Over'}\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Budget Utilization */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Budget Utilization</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-sm font-medium\">Utilization: {data.budgetAnalysis.utilizationPercent.toFixed(1)}%</span>\n                    <Badge variant={data.budgetAnalysis.utilizationPercent > 95 ? 'destructive' : \n                                  data.budgetAnalysis.utilizationPercent > 80 ? 'default' : 'secondary'}>\n                      {data.budgetAnalysis.utilizationPercent > 95 ? 'Over Budget' : \n                       data.budgetAnalysis.utilizationPercent > 80 ? 'Near Limit' : 'On Track'}\n                    </Badge>\n                  </div>\n                  <Progress \n                    value={Math.min(data.budgetAnalysis.utilizationPercent, 100)} \n                    className=\"h-3\"\n                  />\n                  <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                    <div>\n                      <div className=\"font-medium\">Actual</div>\n                      <div className=\"text-muted-foreground\">{formatCurrency(data.budgetAnalysis.totalActualCost)}</div>\n                    </div>\n                    <div>\n                      <div className=\"font-medium\">Committed</div>\n                      <div className=\"text-muted-foreground\">{formatCurrency(data.budgetAnalysis.totalCommitted)}</div>\n                    </div>\n                    <div>\n                      <div className=\"font-medium\">Remaining</div>\n                      <div className=\"text-muted-foreground\">\n                        {formatCurrency(Math.max(0, data.budgetAnalysis.totalBudget - data.budgetAnalysis.totalActualCost - data.budgetAnalysis.totalCommitted))}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"cost-breakdown\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Cost Breakdown by Category</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n                  {Object.entries(data.costSummary).map(([costHead, amount]) => (\n                    <Card key={costHead} className=\"text-center\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"text-3xl mb-2\">{getCostHeadIcon(costHead)}</div>\n                        <div className=\"text-2xl font-bold\">{formatCurrency(amount)}</div>\n                        <div className=\"text-sm text-muted-foreground capitalize\">{costHead}</div>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          {((amount / Object.values(data.costSummary).reduce((a, b) => a + b, 0)) * 100).toFixed(1)}%\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"cost-centers\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Cost Centers Performance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Cost Center</TableHead>\n                      <TableHead className=\"text-right\">Budget</TableHead>\n                      <TableHead className=\"text-right\">Actual Cost</TableHead>\n                      <TableHead className=\"text-right\">Committed</TableHead>\n                      <TableHead className=\"text-right\">Variance</TableHead>\n                      <TableHead className=\"text-right\">Utilization</TableHead>\n                      <TableHead>Status</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {data.costCenters.map((center) => {\n                      const variance = center.budget - center.actualCost;\n                      const utilization = center.budget > 0 ? (center.actualCost / center.budget) * 100 : 0;\n                      \n                      return (\n                        <TableRow key={center._id}>\n                          <TableCell className=\"font-medium\">{center.name}</TableCell>\n                          <TableCell className=\"text-right\">{formatCurrency(center.budget)}</TableCell>\n                          <TableCell className=\"text-right\">{formatCurrency(center.actualCost)}</TableCell>\n                          <TableCell className=\"text-right\">{formatCurrency(center.committedCost)}</TableCell>\n                          <TableCell className={`text-right ${getVarianceColor(variance)}`}>\n                            {formatCurrency(Math.abs(variance))}\n                            {variance < 0 && ' Over'}\n                          </TableCell>\n                          <TableCell className=\"text-right\">{utilization.toFixed(1)}%</TableCell>\n                          <TableCell>\n                            <Badge variant={utilization > 95 ? 'destructive' : \n                                          utilization > 80 ? 'default' : 'secondary'}>\n                              {utilization > 95 ? 'Over Budget' : \n                               utilization > 80 ? 'Near Limit' : 'On Track'}\n                            </Badge>\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"transactions\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Recent Transactions</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Date</TableHead>\n                      <TableHead>Description</TableHead>\n                      <TableHead>Account</TableHead>\n                      <TableHead>Reference</TableHead>\n                      <TableHead className=\"text-right\">Debit</TableHead>\n                      <TableHead className=\"text-right\">Credit</TableHead>\n                      <TableHead>Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {data.recentTransactions.map((transaction) => (\n                      <TableRow key={transaction._id}>\n                        <TableCell>{new Date(transaction.date).toLocaleDateString()}</TableCell>\n                        <TableCell>{transaction.description}</TableCell>\n                        <TableCell>\n                          <div>\n                            <div className=\"font-medium\">{transaction.accountId.name}</div>\n                            <div className=\"text-sm text-muted-foreground\">{transaction.accountId.code}</div>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div>\n                            <div className=\"font-medium\">{transaction.journalEntryId.entryNumber}</div>\n                            <div className=\"text-sm text-muted-foreground\">{transaction.journalEntryId.reference}</div>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          {transaction.debit > 0 && formatCurrency(transaction.debit)}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          {transaction.credit > 0 && formatCurrency(transaction.credit)}\n                        </TableCell>\n                        <TableCell>\n                          <Button variant=\"outline\" size=\"sm\">\n                            <Eye className=\"w-4 h-4\" />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      ) : (\n        <Card>\n          <CardContent className=\"text-center py-8\">\n            <Building className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n            <p className=\"text-muted-foreground\">Select a project to view the cost report</p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nexport default ProjectCostReport;