'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Download, Filter, Calendar } from 'lucide-react';\nimport { toast } from '@/hooks/use-toast';\n\ninterface TrialBalanceItem {\n  accountCode: string;\n  accountName: string;\n  accountType: string;\n  openingBalance: number;\n  totalDebit: number;\n  totalCredit: number;\n  closingBalance: number;\n}\n\ninterface TrialBalanceData {\n  trialBalance: TrialBalanceItem[];\n  summary: {\n    totalDebits: number;\n    totalCredits: number;\n    accountCount: number;\n  };\n}\n\nconst TrialBalance = () => {\n  const [data, setData] = useState<TrialBalanceData | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [filters, setFilters] = useState({\n    fromDate: '',\n    toDate: '',\n    projectId: '',\n    consolidated: false\n  });\n\n  useEffect(() => {\n    fetchTrialBalance();\n  }, []);\n\n  const fetchTrialBalance = async () => {\n    try {\n      setLoading(true);\n      const queryParams = new URLSearchParams();\n      if (filters.fromDate) queryParams.append('fromDate', filters.fromDate);\n      if (filters.toDate) queryParams.append('toDate', filters.toDate);\n      if (filters.projectId) queryParams.append('projectId', filters.projectId);\n      queryParams.append('consolidated', filters.consolidated.toString());\n      \n      const response = await fetch(`/api/gl/reports/trial-balance?${queryParams}`);\n      if (response.ok) {\n        const result = await response.json();\n        setData(result);\n      } else {\n        throw new Error('Failed to fetch trial balance');\n      }\n    } catch (error) {\n      toast({ title: 'Error', description: 'Failed to fetch trial balance', variant: 'destructive' });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const exportToExcel = async () => {\n    try {\n      const queryParams = new URLSearchParams();\n      if (filters.fromDate) queryParams.append('fromDate', filters.fromDate);\n      if (filters.toDate) queryParams.append('toDate', filters.toDate);\n      if (filters.projectId) queryParams.append('projectId', filters.projectId);\n      queryParams.append('consolidated', filters.consolidated.toString());\n      queryParams.append('format', 'excel');\n      \n      const response = await fetch(`/api/gl/reports/trial-balance?${queryParams}`);\n      if (response.ok) {\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `trial-balance-${new Date().toISOString().split('T')[0]}.xlsx`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n        toast({ title: 'Success', description: 'Trial balance exported successfully' });\n      }\n    } catch (error) {\n      toast({ title: 'Error', description: 'Failed to export trial balance', variant: 'destructive' });\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-IN', {\n      style: 'currency',\n      currency: 'INR',\n      minimumFractionDigits: 2\n    }).format(amount);\n  };\n\n  const getAccountTypeBadge = (type: string) => {\n    const colors = {\n      asset: 'bg-blue-100 text-blue-800',\n      liability: 'bg-red-100 text-red-800',\n      equity: 'bg-green-100 text-green-800',\n      income: 'bg-purple-100 text-purple-800',\n      expense: 'bg-orange-100 text-orange-800'\n    };\n    return (\n      <Badge className={colors[type as keyof typeof colors] || 'bg-gray-100 text-gray-800'}>\n        {type.toUpperCase()}\n      </Badge>\n    );\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-3xl font-bold\">Trial Balance</h1>\n        <div className=\"flex gap-2\">\n          <Button onClick={exportToExcel} variant=\"outline\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export Excel\n          </Button>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Filter className=\"w-5 h-5\" />\n            Filters\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">From Date</label>\n              <Input\n                type=\"date\"\n                value={filters.fromDate}\n                onChange={(e) => setFilters(prev => ({ ...prev, fromDate: e.target.value }))}\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">To Date</label>\n              <Input\n                type=\"date\"\n                value={filters.toDate}\n                onChange={(e) => setFilters(prev => ({ ...prev, toDate: e.target.value }))}\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">Project</label>\n              <Select value={filters.projectId} onValueChange={(value) => setFilters(prev => ({ ...prev, projectId: value }))}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"All Projects\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"\">All Projects</SelectItem>\n                  <SelectItem value=\"project1\">Project 1</SelectItem>\n                  <SelectItem value=\"project2\">Project 2</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex items-end\">\n              <Button onClick={fetchTrialBalance} className=\"w-full\">\n                <Filter className=\"w-4 h-4 mr-2\" />\n                Apply Filters\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Trial Balance Table */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex justify-between items-center\">\n            <CardTitle>Trial Balance Report</CardTitle>\n            {data && (\n              <div className=\"text-sm text-muted-foreground\">\n                As of {filters.toDate || new Date().toLocaleDateString()}\n              </div>\n            )}\n          </div>\n        </CardHeader>\n        <CardContent>\n          {loading ? (\n            <div className=\"flex justify-center items-center h-32\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n            </div>\n          ) : data ? (\n            <>\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Account Code</TableHead>\n                      <TableHead>Account Name</TableHead>\n                      <TableHead>Type</TableHead>\n                      <TableHead className=\"text-right\">Opening Balance</TableHead>\n                      <TableHead className=\"text-right\">Total Debit</TableHead>\n                      <TableHead className=\"text-right\">Total Credit</TableHead>\n                      <TableHead className=\"text-right\">Closing Balance</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {data.trialBalance.map((item, index) => (\n                      <TableRow key={index}>\n                        <TableCell className=\"font-medium\">{item.accountCode}</TableCell>\n                        <TableCell>{item.accountName}</TableCell>\n                        <TableCell>{getAccountTypeBadge(item.accountType)}</TableCell>\n                        <TableCell className=\"text-right\">{formatCurrency(item.openingBalance)}</TableCell>\n                        <TableCell className=\"text-right\">{formatCurrency(item.totalDebit)}</TableCell>\n                        <TableCell className=\"text-right\">{formatCurrency(item.totalCredit)}</TableCell>\n                        <TableCell className={`text-right font-medium ${\n                          item.closingBalance >= 0 ? 'text-green-600' : 'text-red-600'\n                        }`}>\n                          {formatCurrency(Math.abs(item.closingBalance))}\n                          {item.closingBalance < 0 && ' (Cr)'}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n              \n              {/* Summary */}\n              <div className=\"mt-6 p-4 bg-gray-50 rounded-lg\">\n                <h3 className=\"text-lg font-semibold mb-3\">Summary</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div className=\"text-center\">\n                    <div className=\"text-2xl font-bold text-blue-600\">\n                      {formatCurrency(data.summary.totalDebits)}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">Total Debits</div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"text-2xl font-bold text-green-600\">\n                      {formatCurrency(data.summary.totalCredits)}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">Total Credits</div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"text-2xl font-bold text-gray-600\">\n                      {data.summary.accountCount}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">Total Accounts</div>\n                  </div>\n                </div>\n                \n                {Math.abs(data.summary.totalDebits - data.summary.totalCredits) > 0.01 && (\n                  <div className=\"mt-4 p-3 bg-red-100 border border-red-300 rounded-lg\">\n                    <div className=\"text-red-800 font-medium\">\n                      ⚠️ Trial Balance is not balanced!\n                    </div>\n                    <div className=\"text-red-600 text-sm\">\n                      Difference: {formatCurrency(Math.abs(data.summary.totalDebits - data.summary.totalCredits))}\n                    </div>\n                  </div>\n                )}\n                \n                {Math.abs(data.summary.totalDebits - data.summary.totalCredits) <= 0.01 && (\n                  <div className=\"mt-4 p-3 bg-green-100 border border-green-300 rounded-lg\">\n                    <div className=\"text-green-800 font-medium\">\n                      ✅ Trial Balance is balanced!\n                    </div>\n                  </div>\n                )}\n              </div>\n            </>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              No data available. Please apply filters and try again.\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default TrialBalance;