import { JournalEntry } from '../models/JournalEntry';
import { ChartOfAccounts } from '../models/ChartOfAccounts';
import { Ledger } from '../models/Ledger';
import { SubsidiaryLedger } from '../models/SubsidiaryLedger';
import { WIPLedger } from '../models/WIPLedger';
import mongoose from 'mongoose';

export class GLIntegration {
  // Auto-create journal entry from procurement
  static async createProcurementEntry(data: {
    vendorId: string;
    amount: number;
    projectId: string;
    costCenterId: string;
    description: string;
    reference: string;
    date: Date;
    costHead: 'material' | 'labour' | 'equipment' | 'subcontractor' | 'overhead';
  }) {
    try {
      // Find relevant accounts
      const expenseAccount = await ChartOfAccounts.findOne({ 
        type: 'expense', 
        subType: data.costHead 
      });
      const payableAccount = await ChartOfAccounts.findOne({ 
        type: 'liability', 
        subType: 'Accounts Payable' 
      });

      if (!expenseAccount || !payableAccount) {\n        throw new Error('Required accounts not found');\n      }\n\n      // Create journal entry\n      const journalEntry = new JournalEntry({\n        date: data.date,\n        reference: data.reference,\n        description: data.description,\n        sourceModule: 'ap',\n        projectId: data.projectId,\n        lines: [\n          {\n            accountId: expenseAccount._id,\n            description: `${data.costHead} expense - ${data.description}`,\n            debit: data.amount,\n            credit: 0,\n            projectId: data.projectId,\n            costCenterId: data.costCenterId,\n            costHead: data.costHead\n          },\n          {\n            accountId: payableAccount._id,\n            description: `Vendor payable - ${data.description}`,\n            debit: 0,\n            credit: data.amount,\n            projectId: data.projectId\n          }\n        ],\n        totalDebit: data.amount,\n        totalCredit: data.amount,\n        status: 'approved',\n        createdBy: new mongoose.Types.ObjectId() // Should be actual user ID\n      });\n\n      await journalEntry.save();\n\n      // Auto-post if configured\n      await this.postJournalEntry(journalEntry._id.toString());\n\n      // Create WIP entry\n      await this.createWIPEntry({\n        projectId: data.projectId,\n        costHead: data.costHead,\n        amount: data.amount,\n        description: data.description,\n        journalEntryId: journalEntry._id.toString(),\n        date: data.date,\n        reference: data.reference\n      });\n\n      return journalEntry;\n    } catch (error) {\n      throw new Error(`Failed to create procurement entry: ${error}`);\n    }\n  }\n\n  // Auto-create journal entry from payroll\n  static async createPayrollEntry(data: {\n    employeeId: string;\n    grossSalary: number;\n    deductions: number;\n    netSalary: number;\n    projectId: string;\n    costCenterId: string;\n    description: string;\n    reference: string;\n    date: Date;\n  }) {\n    try {\n      const salaryExpenseAccount = await ChartOfAccounts.findOne({ \n        type: 'expense', \n        subType: 'Salary' \n      });\n      const payableAccount = await ChartOfAccounts.findOne({ \n        type: 'liability', \n        subType: 'Salary Payable' \n      });\n      const deductionAccount = await ChartOfAccounts.findOne({ \n        type: 'liability', \n        subType: 'Deductions Payable' \n      });\n\n      if (!salaryExpenseAccount || !payableAccount || !deductionAccount) {\n        throw new Error('Required payroll accounts not found');\n      }\n\n      const journalEntry = new JournalEntry({\n        date: data.date,\n        reference: data.reference,\n        description: data.description,\n        sourceModule: 'payroll',\n        projectId: data.projectId,\n        lines: [\n          {\n            accountId: salaryExpenseAccount._id,\n            description: `Salary expense - ${data.description}`,\n            debit: data.grossSalary,\n            credit: 0,\n            projectId: data.projectId,\n            costCenterId: data.costCenterId,\n            costHead: 'labour'\n          },\n          {\n            accountId: payableAccount._id,\n            description: `Net salary payable - ${data.description}`,\n            debit: 0,\n            credit: data.netSalary,\n            projectId: data.projectId\n          },\n          {\n            accountId: deductionAccount._id,\n            description: `Deductions - ${data.description}`,\n            debit: 0,\n            credit: data.deductions,\n            projectId: data.projectId\n          }\n        ],\n        totalDebit: data.grossSalary,\n        totalCredit: data.grossSalary,\n        status: 'approved',\n        createdBy: new mongoose.Types.ObjectId()\n      });\n\n      await journalEntry.save();\n      await this.postJournalEntry(journalEntry._id.toString());\n\n      // Create WIP entry for labour cost\n      await this.createWIPEntry({\n        projectId: data.projectId,\n        costHead: 'labour',\n        amount: data.grossSalary,\n        description: data.description,\n        journalEntryId: journalEntry._id.toString(),\n        date: data.date,\n        reference: data.reference\n      });\n\n      return journalEntry;\n    } catch (error) {\n      throw new Error(`Failed to create payroll entry: ${error}`);\n    }\n  }\n\n  // Auto-create journal entry from billing/invoicing\n  static async createBillingEntry(data: {\n    customerId: string;\n    amount: number;\n    taxAmount: number;\n    projectId: string;\n    description: string;\n    reference: string;\n    date: Date;\n    invoiceNumber: string;\n  }) {\n    try {\n      const receivableAccount = await ChartOfAccounts.findOne({ \n        type: 'asset', \n        subType: 'Accounts Receivable' \n      });\n      const revenueAccount = await ChartOfAccounts.findOne({ \n        type: 'income', \n        subType: 'Contract Revenue' \n      });\n      const taxAccount = await ChartOfAccounts.findOne({ \n        type: 'liability', \n        subType: 'GST Payable' \n      });\n\n      if (!receivableAccount || !revenueAccount || !taxAccount) {\n        throw new Error('Required billing accounts not found');\n      }\n\n      const totalAmount = data.amount + data.taxAmount;\n\n      const journalEntry = new JournalEntry({\n        date: data.date,\n        reference: data.reference,\n        description: data.description,\n        sourceModule: 'billing',\n        projectId: data.projectId,\n        lines: [\n          {\n            accountId: receivableAccount._id,\n            description: `Invoice receivable - ${data.invoiceNumber}`,\n            debit: totalAmount,\n            credit: 0,\n            projectId: data.projectId\n          },\n          {\n            accountId: revenueAccount._id,\n            description: `Contract revenue - ${data.description}`,\n            debit: 0,\n            credit: data.amount,\n            projectId: data.projectId\n          },\n          {\n            accountId: taxAccount._id,\n            description: `GST on invoice - ${data.invoiceNumber}`,\n            debit: 0,\n            credit: data.taxAmount,\n            projectId: data.projectId\n          }\n        ],\n        totalDebit: totalAmount,\n        totalCredit: totalAmount,\n        status: 'approved',\n        createdBy: new mongoose.Types.ObjectId()\n      });\n\n      await journalEntry.save();\n      await this.postJournalEntry(journalEntry._id.toString());\n\n      return journalEntry;\n    } catch (error) {\n      throw new Error(`Failed to create billing entry: ${error}`);\n    }\n  }\n\n  // Post journal entry and create ledger entries\n  static async postJournalEntry(journalEntryId: string) {\n    try {\n      const journalEntry = await JournalEntry.findById(journalEntryId)\n        .populate('lines.accountId');\n\n      if (!journalEntry || journalEntry.isPosted) {\n        throw new Error('Journal entry not found or already posted');\n      }\n\n      // Create ledger entries\n      for (const line of journalEntry.lines) {\n        const account = await ChartOfAccounts.findById(line.accountId);\n        if (!account) continue;\n\n        // Calculate new balance\n        let newBalance = account.balance;\n        if (['asset', 'expense'].includes(account.type)) {\n          newBalance += (line.debit - line.credit);\n        } else {\n          newBalance += (line.credit - line.debit);\n        }\n\n        // Create ledger entry\n        const ledgerEntry = new Ledger({\n          accountId: line.accountId,\n          date: journalEntry.date,\n          description: line.description,\n          debit: line.debit,\n          credit: line.credit,\n          balance: newBalance,\n          journalEntryId: journalEntry._id,\n          reference: journalEntry.reference\n        });\n\n        await ledgerEntry.save();\n\n        // Update account balance\n        account.balance = newBalance;\n        await account.save();\n\n        // Create subsidiary ledger entry if applicable\n        if (account.subType === 'Accounts Payable' || account.subType === 'Accounts Receivable') {\n          const subsidiaryEntry = new SubsidiaryLedger({\n            type: account.subType === 'Accounts Payable' ? 'vendor' : 'customer',\n            entityId: new mongoose.Types.ObjectId(), // Should be actual vendor/customer ID\n            accountId: line.accountId,\n            date: journalEntry.date,\n            description: line.description,\n            debit: line.debit,\n            credit: line.credit,\n            balance: newBalance,\n            journalEntryId: journalEntry._id,\n            reference: journalEntry.reference,\n            projectId: line.projectId\n          });\n\n          await subsidiaryEntry.save();\n        }\n      }\n\n      // Mark journal entry as posted\n      journalEntry.isPosted = true;\n      journalEntry.status = 'posted';\n      journalEntry.postedAt = new Date();\n      await journalEntry.save();\n\n      return journalEntry;\n    } catch (error) {\n      throw new Error(`Failed to post journal entry: ${error}`);\n    }\n  }\n\n  // Create WIP ledger entry\n  static async createWIPEntry(data: {\n    projectId: string;\n    costHead: 'material' | 'labour' | 'equipment' | 'subcontractor' | 'overhead';\n    amount: number;\n    description: string;\n    journalEntryId: string;\n    date: Date;\n    reference: string;\n    boqItemId?: string;\n    activityId?: string;\n  }) {\n    try {\n      // Get cumulative amount for this project and cost head\n      const previousWIP = await WIPLedger.findOne({\n        projectId: data.projectId,\n        costHead: data.costHead\n      }).sort({ date: -1 });\n\n      const cumulativeAmount = (previousWIP?.cumulativeAmount || 0) + data.amount;\n\n      const wipEntry = new WIPLedger({\n        projectId: data.projectId,\n        boqItemId: data.boqItemId ? new mongoose.Types.ObjectId(data.boqItemId) : undefined,\n        activityId: data.activityId ? new mongoose.Types.ObjectId(data.activityId) : undefined,\n        date: data.date,\n        description: data.description,\n        costHead: data.costHead,\n        amount: data.amount,\n        cumulativeAmount,\n        journalEntryId: new mongoose.Types.ObjectId(data.journalEntryId),\n        reference: data.reference\n      });\n\n      await wipEntry.save();\n      return wipEntry;\n    } catch (error) {\n      throw new Error(`Failed to create WIP entry: ${error}`);\n    }\n  }\n\n  // Capitalize WIP to fixed assets\n  static async capitalizeWIP(projectId: string, capitalizedAmount: number) {\n    try {\n      const wipAccount = await ChartOfAccounts.findOne({ \n        type: 'asset', \n        subType: 'Work in Progress' \n      });\n      const fixedAssetAccount = await ChartOfAccounts.findOne({ \n        type: 'asset', \n        subType: 'Fixed Assets' \n      });\n\n      if (!wipAccount || !fixedAssetAccount) {\n        throw new Error('Required capitalization accounts not found');\n      }\n\n      // Create capitalization journal entry\n      const journalEntry = new JournalEntry({\n        date: new Date(),\n        reference: `CAP-${projectId}`,\n        description: `WIP Capitalization for Project ${projectId}`,\n        sourceModule: 'manual',\n        projectId: new mongoose.Types.ObjectId(projectId),\n        lines: [\n          {\n            accountId: fixedAssetAccount._id,\n            description: `Capitalized WIP - Project ${projectId}`,\n            debit: capitalizedAmount,\n            credit: 0,\n            projectId: new mongoose.Types.ObjectId(projectId)\n          },\n          {\n            accountId: wipAccount._id,\n            description: `WIP transfer to Fixed Assets - Project ${projectId}`,\n            debit: 0,\n            credit: capitalizedAmount,\n            projectId: new mongoose.Types.ObjectId(projectId)\n          }\n        ],\n        totalDebit: capitalizedAmount,\n        totalCredit: capitalizedAmount,\n        status: 'approved',\n        createdBy: new mongoose.Types.ObjectId()\n      });\n\n      await journalEntry.save();\n      await this.postJournalEntry(journalEntry._id.toString());\n\n      // Update WIP ledger entries\n      await WIPLedger.updateMany(\n        { projectId: new mongoose.Types.ObjectId(projectId), isCapitalized: false },\n        { \n          isCapitalized: true, \n          capitalizedDate: new Date(),\n          capitalizedAmount: capitalizedAmount\n        }\n      );\n\n      return journalEntry;\n    } catch (error) {\n      throw new Error(`Failed to capitalize WIP: ${error}`);\n    }\n  }\n\n  // Generate depreciation entries\n  static async generateDepreciationEntries(assetId: string, depreciationAmount: number, date: Date) {\n    try {\n      const depreciationExpenseAccount = await ChartOfAccounts.findOne({ \n        type: 'expense', \n        subType: 'Depreciation' \n      });\n      const accumulatedDepreciationAccount = await ChartOfAccounts.findOne({ \n        type: 'asset', \n        subType: 'Accumulated Depreciation' \n      });\n\n      if (!depreciationExpenseAccount || !accumulatedDepreciationAccount) {\n        throw new Error('Required depreciation accounts not found');\n      }\n\n      const journalEntry = new JournalEntry({\n        date,\n        reference: `DEP-${assetId}`,\n        description: `Monthly depreciation for asset ${assetId}`,\n        sourceModule: 'assets',\n        lines: [\n          {\n            accountId: depreciationExpenseAccount._id,\n            description: `Depreciation expense - Asset ${assetId}`,\n            debit: depreciationAmount,\n            credit: 0\n          },\n          {\n            accountId: accumulatedDepreciationAccount._id,\n            description: `Accumulated depreciation - Asset ${assetId}`,\n            debit: 0,\n            credit: depreciationAmount\n          }\n        ],\n        totalDebit: depreciationAmount,\n        totalCredit: depreciationAmount,\n        status: 'approved',\n        createdBy: new mongoose.Types.ObjectId()\n      });\n\n      await journalEntry.save();\n      await this.postJournalEntry(journalEntry._id.toString());\n\n      return journalEntry;\n    } catch (error) {\n      throw new Error(`Failed to generate depreciation entry: ${error}`);\n    }\n  }\n}